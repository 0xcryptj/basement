<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lucky Block Jackpot - The Basement Arcade</title>
    <link rel="icon" href="../assets/icon.ico" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Match main site styling */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Press Start 2P', monospace;
            background-color: #0A0A0A;
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
            text-shadow: 0 0 8px #0052ff99;
        }
        
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: url('../assets/bk3.png') center/cover no-repeat;
            background-attachment: fixed;
            z-index: -1;
        }
        
        body::-webkit-scrollbar {
            width: 8px;
        }
        
        body::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
        }
        
        body::-webkit-scrollbar-thumb {
            background: rgba(0, 82, 255, 0.5);
            border-radius: 4px;
        }
        
        /* Navbar - match main site */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 9999;
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
        }
        
        .logo {
            font-family: 'Press Start 2P', monospace;
            font-size: 0.8rem;
            color: #0052ff;
            text-shadow: 0 0 10px #0052ff;
        }
        
        .nav-links {
            display: flex;
            gap: 20px;
        }
        
        .nav-link {
            color: #fff;
            text-decoration: none;
            font-size: 0.6rem;
            transition: all 0.3s;
            position: relative;
            padding: 5px 10px;
        }
        
        .nav-link::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background: #00BFFF;
            transition: width 0.3s;
        }
        
        .nav-link:hover {
            color: #00BFFF;
            text-shadow: 0 0 10px #00BFFF;
        }
        
        .nav-link:hover::after {
            width: 100%;
        }
        
        .nav-link.active {
            color: #00FF88;
            text-shadow: 0 0 10px #00FF88;
        }
        
        .wallet-btn {
            background: rgba(0, 82, 255, 0.3);
            border: 2px solid #0052ff99;
            color: #00BFFF;
            padding: 8px 16px;
            font-family: 'Press Start 2P', monospace;
            font-size: 0.6rem;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 3px;
        }
        
        .wallet-btn:hover {
            background: rgba(0, 82, 255, 0.5);
            box-shadow: 0 0 15px rgba(0, 82, 255, 0.6);
        }
        
        .wallet-connected {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .wallet-address {
            font-size: 0.6rem;
            color: #00FF88;
        }
        
        /* Container */
        .container {
            max-width: 1400px;
            margin: 80px auto 20px;
            padding: 20px;
        }
        
        /* Warning Banner */
        .warning-banner {
            background: rgba(255, 0, 82, 0.1);
            border: 2px solid #ff0052;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .warning-title {
            color: #ff0052;
            font-size: 0.7rem;
            margin-bottom: 8px;
            text-shadow: 0 0 10px #ff0052;
        }
        
        .warning-text {
            font-size: 0.5rem;
            line-height: 1.6;
            font-family: 'Courier Prime', monospace;
        }
        
        /* Layout */
        .game-layout {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 20px;
        }
        
        /* Game Section */
        .game-main {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .game-header {
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #0052ff99;
            border-radius: 8px;
        }
        
        .game-title {
            font-size: 1.5rem;
            color: #ffd700;
            text-shadow: 0 0 20px #ffd700;
            margin-bottom: 10px;
        }
        
        .round-info {
            font-size: 0.6rem;
            color: #00BFFF;
        }
        
        /* Wheel Section - Smaller */
        .wheel-section {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #ffd700;
            border-radius: 8px;
            padding: 20px;
        }
        
        .wheel-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            aspect-ratio: 1;
        }
        
        #jackpot-wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }
        
        .wheel-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 45%;
            height: 45%;
            background: rgba(10, 10, 26, 0.95);
            border-radius: 50%;
            border: 3px solid #ffd700;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }
        
        .pot-label {
            font-size: 0.5rem;
            color: #888;
            margin-bottom: 5px;
        }
        
        .pot-amount {
            font-size: 1rem;
            color: #ffd700;
            text-shadow: 0 0 15px #ffd700;
        }
        
        .pot-usd {
            font-size: 0.5rem;
            color: #888;
            margin-top: 3px;
        }
        
        .wheel-pointer {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 30px solid #ff0052;
            filter: drop-shadow(0 0 10px #ff0052);
            z-index: 10;
            animation: pointerBob 1s ease-in-out infinite;
        }
        
        @keyframes pointerBob {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-5px); }
        }
        
        /* Timer - Smaller */
        .timer-display {
            text-align: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #00FF88;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .timer-label {
            font-size: 0.5rem;
            color: #888;
            margin-bottom: 8px;
        }
        
        .timer-value {
            font-size: 1.5rem;
            color: #00FF88;
            text-shadow: 0 0 15px #00FF88;
        }
        
        .timer-value.warning {
            color: #ff0052;
            text-shadow: 0 0 15px #ff0052;
            animation: timerBlink 0.5s ease-in-out infinite;
        }
        
        @keyframes timerBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Betting Section - Smaller */
        .betting-section {
            background: rgba(0, 82, 255, 0.1);
            border: 2px solid #0052ff99;
            border-radius: 8px;
            padding: 20px;
        }
        
        .betting-title {
            font-size: 0.7rem;
            color: #00BFFF;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .custom-bet-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #0052ff99;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier Prime', monospace;
            font-size: 0.9rem;
            color: #00BFFF;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .custom-bet-input:focus {
            outline: none;
            border-color: #00BFFF;
            box-shadow: 0 0 15px rgba(0, 191, 255, 0.4);
        }
        
        .bet-controls {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .bet-btn {
            background: rgba(0, 82, 255, 0.3);
            border: 2px solid #0052ff99;
            color: #00BFFF;
            padding: 8px 12px;
            font-family: 'Press Start 2P', monospace;
            font-size: 0.5rem;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 3px;
        }
        
        .bet-btn:hover:not(:disabled) {
            background: rgba(0, 82, 255, 0.5);
            box-shadow: 0 0 10px rgba(0, 82, 255, 0.6);
        }
        
        .bet-display {
            text-align: center;
            margin: 10px 0;
        }
        
        .bet-amount {
            font-size: 1.2rem;
            color: #00BFFF;
            text-shadow: 0 0 10px #00BFFF;
        }
        
        .bet-usd {
            font-size: 0.5rem;
            color: #888;
            margin-top: 5px;
        }
        
        .enter-btn {
            width: 100%;
            background: rgba(0, 255, 0, 0.2);
            border: 2px solid #00FF88;
            color: #00FF88;
            padding: 12px;
            font-family: 'Press Start 2P', monospace;
            font-size: 0.6rem;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 4px;
            text-shadow: 0 0 10px #00FF88;
        }
        
        .enter-btn:hover:not(:disabled) {
            background: rgba(0, 255, 0, 0.3);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.6);
        }
        
        .enter-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Players List - Match forum style */
        .players-section {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #0052ff99;
            border-radius: 8px;
            padding: 15px;
        }
        
        .players-title {
            font-size: 0.7rem;
            color: #00BFFF;
            margin-bottom: 12px;
            text-align: center;
        }
        
        .players-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .player-item {
            background: rgba(0, 82, 255, 0.1);
            border: 1px solid #0052ff99;
            border-radius: 4px;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Courier Prime', monospace;
            font-size: 0.7rem;
        }
        
        .player-address {
            color: #00BFFF;
        }
        
        .player-chance {
            color: #00FF88;
            font-weight: bold;
        }
        
        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        /* Chat - Match IRC style */
        .chat-section {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #0052ff99;
            border-radius: 8px;
            padding: 15px;
            height: 450px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            font-size: 0.7rem;
            color: #00BFFF;
            margin-bottom: 10px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 82, 255, 0.3);
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 10px;
            margin-bottom: 10px;
            font-family: 'Courier Prime', monospace;
        }
        
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(0, 82, 255, 0.5);
            border-radius: 3px;
        }
        
        .chat-message {
            font-size: 0.65rem;
            line-height: 1.5;
        }
        
        .chat-username {
            color: #00BFFF;
            margin-right: 5px;
        }
        
        .chat-text {
            color: rgba(255, 255, 255, 0.9);
        }
        
        .chat-system {
            color: #ffd700;
            font-style: italic;
            text-align: center;
            font-size: 0.6rem;
        }
        
        .chat-input-wrapper {
            display: flex;
            gap: 8px;
        }
        
        .chat-input {
            flex: 1;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #0052ff99;
            border-radius: 4px;
            padding: 8px;
            color: #fff;
            font-family: 'Courier Prime', monospace;
            font-size: 0.7rem;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: #00BFFF;
            box-shadow: 0 0 10px rgba(0, 191, 255, 0.4);
        }
        
        .chat-send-btn {
            background: rgba(0, 82, 255, 0.3);
            border: 2px solid #0052ff99;
            color: #00BFFF;
            padding: 8px 15px;
            font-family: 'Press Start 2P', monospace;
            font-size: 0.5rem;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 4px;
        }
        
        .chat-send-btn:hover {
            background: rgba(0, 82, 255, 0.5);
            box-shadow: 0 0 10px rgba(0, 82, 255, 0.6);
        }
        
        /* Stats */
        .stats-section {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #0052ff99;
            border-radius: 8px;
            padding: 15px;
        }
        
        .stats-header {
            font-size: 0.7rem;
            color: #00BFFF;
            margin-bottom: 12px;
            text-align: center;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .stat-box {
            background: rgba(0, 82, 255, 0.1);
            border: 1px solid #0052ff99;
            border-radius: 4px;
            padding: 10px;
            text-align: center;
        }
        
        .stat-label {
            font-size: 0.5rem;
            color: #888;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 0.9rem;
            color: #00BFFF;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: rgba(10, 10, 26, 0.95);
            border: 2px solid #0052ff99;
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
        }
        
        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #888;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .modal-title {
            font-size: 0.9rem;
            color: #00BFFF;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .wallet-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .wallet-option {
            background: rgba(0, 82, 255, 0.2);
            border: 2px solid #0052ff99;
            border-radius: 4px;
            padding: 15px;
            color: #00BFFF;
            font-family: 'Press Start 2P', monospace;
            font-size: 0.6rem;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .wallet-option:hover {
            background: rgba(0, 82, 255, 0.4);
            box-shadow: 0 0 15px rgba(0, 82, 255, 0.6);
        }
        
        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 191, 255, 0.3);
            border-top: 3px solid #00BFFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .btn-loading {
            opacity: 0.7;
            pointer-events: none;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            top: 80px;
            right: 20px;
            background: rgba(0, 82, 255, 0.9);
            border: 2px solid #0052ff;
            color: white;
            padding: 15px 25px;
            border-radius: 4px;
            font-family: 'Press Start 2P', monospace;
            font-size: 0.6rem;
            z-index: 20000;
            box-shadow: 0 0 20px rgba(0, 82, 255, 0.6);
            animation: toastSlide 0.3s ease-out;
        }
        
        @keyframes toastSlide {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .toast.success {
            background: rgba(0, 255, 136, 0.9);
            border-color: #00FF88;
            color: #000;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.6);
        }
        
        .toast.error {
            background: rgba(255, 0, 82, 0.9);
            border-color: #ff0052;
            box-shadow: 0 0 20px rgba(255, 0, 82, 0.6);
        }
        
        /* Help Button */
        .help-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: rgba(0, 82, 255, 0.3);
            border: 2px solid #0052ff99;
            border-radius: 50%;
            color: #00BFFF;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .help-btn:hover {
            background: rgba(0, 82, 255, 0.6);
            box-shadow: 0 0 20px rgba(0, 82, 255, 0.8);
            transform: scale(1.1);
        }
        
        /* Confetti */
        .confetti {
            position: fixed;
            width: 8px;
            height: 8px;
            animation: confettiFall 3s linear forwards;
            z-index: 999;
        }
        
        @keyframes confettiFall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        /* Winner Overlay */
        .winner-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 15000;
            align-items: center;
            justify-content: center;
        }
        
        .winner-overlay.show {
            display: flex;
        }
        
        .winner-content {
            text-align: center;
            animation: winnerPop 0.6s ease-out;
        }
        
        @keyframes winnerPop {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }
            70% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .winner-announcement {
            font-size: 2rem;
            color: #ffd700;
            text-shadow: 0 0 30px #ffd700;
            margin-bottom: 20px;
        }
        
        .winner-details {
            background: rgba(10, 10, 26, 0.95);
            border: 3px solid #ffd700;
            border-radius: 8px;
            padding: 30px;
            min-width: 400px;
        }
        
        .winner-address-big {
            font-size: 0.8rem;
            color: #00BFFF;
            margin-bottom: 15px;
        }
        
        .winner-prize {
            font-size: 2rem;
            color: #00FF88;
            text-shadow: 0 0 20px #00FF88;
            margin-bottom: 10px;
        }
        
        .winner-chance {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 20px;
        }
        
        .winner-close-btn {
            background: rgba(0, 82, 255, 0.3);
            border: 2px solid #0052ff99;
            color: #00BFFF;
            padding: 10px 25px;
            font-family: 'Press Start 2P', monospace;
            font-size: 0.6rem;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .winner-close-btn:hover {
            background: rgba(0, 82, 255, 0.5);
            box-shadow: 0 0 15px rgba(0, 82, 255, 0.6);
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .game-layout {
                grid-template-columns: 1fr;
            }
            
            .wheel-container {
                max-width: 350px;
            }
        }
        
        @media (max-width: 768px) {
            .game-title {
                font-size: 1rem;
            }
            
            .wheel-container {
                max-width: 280px;
            }
            
            .timer-value {
                font-size: 1.2rem;
            }
            
            .winner-details {
                min-width: auto;
                padding: 20px;
            }
            
            .nav-links {
                display: none;
            }
            
            .betting-title {
                font-size: 0.6rem;
            }
            
            .bet-btn {
                font-size: 0.45rem;
                padding: 6px 10px;
            }
        }
        
        @media (max-width: 400px) {
            .logo {
                font-size: 0.6rem;
            }
            
            .wallet-btn {
                font-size: 0.5rem;
                padding: 6px 12px;
            }
            
            .game-title {
                font-size: 0.9rem;
            }
            
            .wheel-container {
                max-width: 250px;
            }
            
            .pot-amount {
                font-size: 0.9rem;
            }
            
            .timer-value {
                font-size: 1rem;
            }
            
            .bet-controls {
                gap: 5px;
            }
            
            .bet-btn {
                font-size: 0.4rem;
                padding: 5px 8px;
            }
            
            .enter-btn {
                font-size: 0.5rem;
                padding: 10px;
            }
            
            .chat-section {
                height: 300px;
            }
            
            .help-btn {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Nav -->
    <nav class="navbar">
        <div class="logo">🎰 LUCKY BLOCK</div>
        <div class="nav-links">
            <a href="arcade.html" class="nav-link">← Arcade</a>
            <a href="../index.html" class="nav-link">Home</a>
        </div>
        <button class="wallet-btn" id="wallet-btn" onclick="openWalletModal()">Connect</button>
        <div class="wallet-connected" id="wallet-connected" style="display: none;">
            <span class="wallet-address" id="wallet-address"></span>
            <button class="wallet-btn" onclick="disconnectWallet()">Disconnect</button>
        </div>
    </nav>
    
    <div class="container">
        <!-- Network Warning -->
        <div class="warning-banner" style="border-color: #ff9900; background: rgba(255, 153, 0, 0.2);">
            <div class="warning-title" style="color: #ff9900;">⚠️ BASE NETWORK REQUIRED ⚠️</div>
            <p class="warning-text" style="color: #fff;">This game runs on <strong>Base Mainnet (Chain ID: 8453)</strong>. Your wallet MUST be switched to Base network before playing.</p>
            <p class="warning-text" style="margin-top: 10px; font-size: 0.5rem; color: #00FF88;">
                ✅ Live Contract: 0x0601...d440 | Playing with REAL ETH | 5% house fee | Provably fair
            </p>
        </div>
        
        <!-- Live Stats Banner -->
        <div style="background: rgba(0, 82, 255, 0.1); border: 2px solid #0052ff99; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; text-align: center;">
                <div>
                    <div style="font-family: 'Press Start 2P', monospace; font-size: 0.9rem; color: #00BFFF;" id="online-users-stat">0</div>
                    <div style="font-family: 'Courier Prime', monospace; font-size: 0.6rem; color: #888; margin-top: 5px;">👥 Online Now</div>
                </div>
                <div>
                    <div style="font-family: 'Press Start 2P', monospace; font-size: 0.9rem; color: #ffd700;" id="total-wagers-stat">0</div>
                    <div style="font-family: 'Courier Prime', monospace; font-size: 0.6rem; color: #888; margin-top: 5px;">🎲 Total Wagers</div>
                </div>
                <div>
                    <div style="font-family: 'Press Start 2P', monospace; font-size: 0.9rem; color: #00FF88;" id="total-wagered-display">0 ETH</div>
                    <div style="font-family: 'Courier Prime', monospace; font-size: 0.6rem; color: #888; margin-top: 5px;">💰 Total Wagered</div>
                </div>
            </div>
        </div>
        
        <div class="game-layout">
            <!-- Main Game -->
            <div class="game-main">
                <div class="game-header">
                    <h1 class="game-title">💎 JACKPOT 💎</h1>
                    <p class="round-info">Round #<span id="round-number">1</span> | <span id="player-count">0</span>/20 Players</p>
                </div>
                
                <!-- Wheel -->
                <div class="wheel-section">
                    <div class="wheel-container">
                        <div class="wheel-pointer"></div>
                        <canvas id="jackpot-wheel"></canvas>
                        <div class="wheel-center">
                            <div class="pot-label">POT</div>
                            <div class="pot-amount" id="pot-amount">0.00</div>
                            <div class="pot-usd" id="pot-usd">$0</div>
                        </div>
                    </div>
                </div>
                
                <!-- Timer -->
                <div class="timer-display">
                    <div class="timer-label">TIME LEFT</div>
                    <div class="timer-value" id="timer">1:00</div>
                </div>
                
                <!-- Betting -->
                <div class="betting-section">
                    <h3 class="betting-title">PLACE BET</h3>
                    <input type="number" id="custom-bet-input" class="custom-bet-input" placeholder="0.001" step="0.001" min="0.0001" value="0.001" oninput="updateBetDisplay()">
                    <div class="bet-controls">
                        <button class="bet-btn" onclick="adjustBet(0.001)">+0.001</button>
                        <button class="bet-btn" onclick="adjustBet(0.01)">+0.01</button>
                        <button class="bet-btn" onclick="adjustBet(0.1)">+0.1</button>
                        <button class="bet-btn" onclick="resetBet()">Clear</button>
                    </div>
                    <div class="bet-display">
                        <div class="bet-amount" id="bet-display">0.001 ETH</div>
                        <div class="bet-usd" id="bet-usd">~$2.00</div>
                    </div>
                    <button class="enter-btn" id="enter-btn" onclick="enterRound()">🎰 ENTER 🎰</button>
                </div>
                
                <!-- Players -->
                <div class="players-section">
                    <h3 class="players-title">PLAYERS</h3>
                    <div class="players-list" id="players-list">
                        <div style="text-align: center; color: #888; font-size: 0.6rem;">Waiting...</div>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Chat -->
                <div class="chat-section">
                    <div class="chat-header">💬 LIVE CHAT 💬</div>
                    <div class="chat-messages" id="chat-messages">
                        <div class="chat-system">Welcome to Lucky Block!</div>
                    </div>
                    <div class="chat-input-wrapper">
                        <input type="text" class="chat-input" id="chat-input" placeholder="Type..." maxlength="100">
                        <button class="chat-send-btn" onclick="sendMessage()">Send</button>
                    </div>
                </div>
                
                <!-- Stats -->
                <div class="stats-section">
                    <div class="stats-header">STATS</div>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-label">Played</div>
                            <div class="stat-value" id="rounds-played">0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Won</div>
                            <div class="stat-value" id="rounds-won">0</div>
                        </div>
                    </div>
                </div>
                
                <!-- Online Users -->
                <div class="stats-section">
                    <div class="stats-header">ONLINE NOW</div>
                    <div id="online-users" style="font-family: 'Courier Prime', monospace; font-size: 0.6rem; color: #888; max-height: 150px; overflow-y: auto;">
                        <div style="text-align: center; padding: 10px;">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Winner Overlay -->
    <div class="winner-overlay" id="winner-overlay">
        <div class="winner-content">
            <div class="winner-announcement">🎉 WINNER! 🎉</div>
            <div class="winner-details" id="winner-details">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>
    
    <!-- Wallet Modal -->
    <div class="modal" id="wallet-modal">
        <div class="modal-content">
            <h2 class="modal-title">CONNECT WALLET</h2>
            <div class="wallet-options">
                <button class="wallet-option" onclick="connectMetaMask()">🦊 MetaMask</button>
                <button class="wallet-option" onclick="connectCoinbase()">💙 Coinbase Wallet</button>
                <button class="wallet-option" onclick="connectPhantom()">👻 Phantom</button>
            </div>
        </div>
    </div>
    
    <!-- Help/Instructions Modal -->
    <div class="modal" id="help-modal">
        <div class="modal-content">
            <h2 class="modal-title">HOW TO PLAY</h2>
            <div style="font-family: 'Courier Prime', monospace; font-size: 0.7rem; line-height: 1.8; color: #ccc; max-height: 400px; overflow-y: auto;">
                <h3 style="color: #00BFFF; font-size: 0.8rem; margin: 15px 0 10px;">🎯 Objective</h3>
                <p>Enter the jackpot with any ETH amount. One random winner takes the entire pot!</p>
                
                <h3 style="color: #00BFFF; font-size: 0.8rem; margin: 15px 0 10px;">💰 How to Play</h3>
                <p>1. Connect your wallet (MetaMask, Coinbase, or Phantom)</p>
                <p>2. Enter your bet amount (min 0.0001 ETH, no maximum)</p>
                <p>3. Click "ENTER" to join the current round</p>
                <p>4. Wait for timer (60 seconds once 2+ players)</p>
                <p>5. Watch the wheel spin to select winner!</p>
                
                <h3 style="color: #00BFFF; font-size: 0.8rem; margin: 15px 0 10px;">⚖️ Weighted Odds</h3>
                <p>Your win chance = (Your Bet / Total Pot) × 100%</p>
                <p><strong>Bigger bets = Better odds!</strong></p>
                <p>Example: Bet 0.1 ETH vs others' 0.01 = 10x better chance</p>
                
                <h3 style="color: #00BFFF; font-size: 0.8rem; margin: 15px 0 10px;">💵 Fees & Payouts</h3>
                <p>• House Fee: 5% of each entry</p>
                <p>• Winner Gets: 95% of total pot</p>
                <p>• Affiliate Bonus: 20% of fees (if referred)</p>
                
                <h3 style="color: #00BFFF; font-size: 0.8rem; margin: 15px 0 10px;">✅ Provably Fair</h3>
                <p>Winner selected using blockchain randomness (blockhash + block data). Completely transparent and verifiable on-chain.</p>
                
                <h3 style="color: #ff0052; font-size: 0.8rem; margin: 15px 0 10px;">⚠️ Beta Warning</h3>
                <p><strong>DO NOT WAGER REAL ETH YET!</strong> Smart contracts are not deployed. This is UI/UX testing only.</p>
            </div>
            <button class="wallet-option" onclick="closeHelpModal()" style="margin-top: 20px;">GOT IT!</button>
        </div>
    </div>
    
    <!-- Help Button -->
    <button class="help-btn" onclick="openHelpModal()" title="How to Play">?</button>
    
    <!-- Scripts -->
    <script src="../security.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>
    <script>
        // Config
        const CONTRACT_ADDRESS = '0xf7Cd6fcc391ad2c771c84159E60BDAEeE9BA821e'; // ✅ LIVE ON BASE MAINNET - LuckyBlock (Deployed Oct 15, 2025)
        const BASE_CHAIN_ID = '0x2105'; // 8453 in decimal
        const BASE_CHAIN_ID_DECIMAL = 8453;
        
        // Track online users
        let onlineWallets = new Set();
        
        // Contract ABI (full version with wagerCount tracking)
        const CONTRACT_ABI = [
            "function enterRound(address referrer) external payable",
            "function getCurrentRound() external view returns (uint256 id, uint256 playerCount, uint256 pot, uint256 timeLeft, bool isActive, uint8 state)",
            "function getRoundPlayers(uint256 roundId) external view returns (address[] memory)",
            "function getRoundBets(uint256 roundId) external view returns (uint256[] memory)",
            "function getPlayerStats(address player) external view returns (uint256 roundsPlayed, uint256 roundsWon, uint256 winRate)",
            "function getGlobalStats() external view returns (uint256 wagered, uint256 roundsCompleted, uint256 uniquePlayers, uint256 currentRound, uint256 activePlayers, uint256 wagerCount)",
            "event PlayerEntered(uint256 indexed roundId, address indexed player, uint256 entryNumber, address indexed referrer)",
            "event WinnerDrawn(uint256 indexed roundId, address indexed winner, uint256 payout, uint256 randomSeed)"
        ];
        
        // State
        let currentBetAmount = 0.001;
        let userAddress;
        let provider;
        let signer;
        let contract;
        let ethPrice = 0;
        let currentPlayers = [];
        let roundTimer = 0;
        let timerInterval;
        let wheelRotation = 0;
        let isSpinning = false;
        let contractDeployed = true; // Contract is deployed
        let isOnBaseNetwork = false; // Track if user is on correct network
        
        // Sound effects
        const sounds = {
            enter: new Audio('../assets/cointoss.mp3'),
            win: new Audio('../assets/win.mp3'),
            tick: new Audio('../assets/flipcard.mp3')
        };
        
        // Preload sounds
        Object.values(sounds).forEach(sound => {
            sound.volume = 0.3;
            sound.load();
        });
        
        function playSound(name) {
            if (sounds[name]) {
                sounds[name].currentTime = 0;
                sounds[name].play().catch(e => console.log('Sound blocked:', e));
            }
        }
        
        // Track online users
        function trackOnlineUser(address) {
            if (address) {
                onlineWallets.add(address.toLowerCase());
                updateOnlineStats();
            }
        }
        
        function updateOnlineStats() {
            document.getElementById('online-users-stat').textContent = onlineWallets.size;
        }
        
        // Load global stats from contract
        async function loadGlobalStatsFromContract() {
            if (!contract) return;
            
            try {
                const stats = await contract.getGlobalStats();
                const [wagered, rounds, players, currentRound, active, wagerCount] = stats;
                
                // Display wager count and total wagered
                document.getElementById('total-wagers-stat').textContent = wagerCount.toString();
                document.getElementById('total-wagered-display').textContent = parseFloat(ethers.formatEther(wagered)).toFixed(4) + ' ETH';
                
            } catch (error) {
                console.error('Failed to load global stats:', error);
            }
        }
        
        // Auto-restore wallet session
        async function restoreWalletSession() {
            const savedWallet = localStorage.getItem('basement_walletAddress');
            const savedUsername = localStorage.getItem('basement_username');
            
            if (!savedWallet) {
                console.log('No saved wallet session');
                return;
            }
            
            console.log('🔄 Restoring wallet session...', savedWallet.substring(0, 10) + '...');
            
            try {
                // Try to auto-connect based on saved wallet type
                if (window.ethereum && window.ethereum.isMetaMask) {
                    // Get current accounts without prompting
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0 && accounts[0].toLowerCase() === savedWallet.toLowerCase()) {
                        console.log('✅ Auto-restoring MetaMask connection');
                        userAddress = accounts[0];
                        provider = new ethers.BrowserProvider(window.ethereum);
                        signer = await provider.getSigner();
                        
                        // Check network
                        const network = await provider.getNetwork();
                        if (Number(network.chainId) === BASE_CHAIN_ID_DECIMAL) {
                            isOnBaseNetwork = true;
                            
                            if (contractDeployed) {
                                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                                await loadUserStats();
                                await loadGlobalStatsFromContract();
                            }
                            
                            // Track online
                            trackOnlineUser(userAddress);
                            
                            // Update UI
                            document.getElementById('wallet-btn').style.display = 'none';
                            document.getElementById('wallet-connected').style.display = 'flex';
                            document.getElementById('wallet-address').textContent = savedUsername || shortenAddress(userAddress);
                            document.getElementById('enter-btn').disabled = false;
                            
                            showToast('✅ Wallet reconnected!', 'success');
                        }
                    }
                } else if (window.phantom && window.phantom.ethereum) {
                    const accounts = await window.phantom.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0 && accounts[0].toLowerCase() === savedWallet.toLowerCase()) {
                        console.log('✅ Auto-restoring Phantom connection');
                        userAddress = accounts[0];
                        provider = new ethers.BrowserProvider(window.phantom.ethereum);
                        signer = await provider.getSigner();
                        
                        const network = await provider.getNetwork();
                        if (Number(network.chainId) === BASE_CHAIN_ID_DECIMAL) {
                            isOnBaseNetwork = true;
                            
                            if (contractDeployed) {
                                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                                await loadUserStats();
                                await loadGlobalStatsFromContract();
                            }
                            
                            trackOnlineUser(userAddress);
                            
                            document.getElementById('wallet-btn').style.display = 'none';
                            document.getElementById('wallet-connected').style.display = 'flex';
                            document.getElementById('wallet-address').textContent = savedUsername || shortenAddress(userAddress);
                            document.getElementById('enter-btn').disabled = false;
                            
                            showToast('✅ Wallet reconnected!', 'success');
                        }
                    }
                }
            } catch (error) {
                console.log('⚠️ Auto-restore failed:', error.message);
                // Silent fail - user can manually connect
            }
        }
        
        // Initialize
        window.addEventListener('load', async () => {
            initWheel();
            await fetchETHPrice();
            updateBetDisplay();
            loadChatMessages();
            
            // Check if contract is deployed
            if (CONTRACT_ADDRESS !== '0x0000000000000000000000000000000000000000') {
                contractDeployed = true;
                await initContract();
                await loadGlobalStatsFromContract(); // Load stats
                setInterval(loadGlobalStatsFromContract, 10000); // Update every 10s
                startContractSync(); // Sync with blockchain
            } else {
                // Contract not deployed - show message
                addChatMessage('SYSTEM', '⚠️ Contract not deployed. Gameplay is simulated for UI testing.');
                document.getElementById('timer').textContent = 'WAITING';
                document.getElementById('enter-btn').disabled = true;
                document.getElementById('enter-btn').textContent = '⏸️ CONTRACT NOT DEPLOYED';
            }
            
            // Auto-restore wallet if previously connected
            await restoreWalletSession();
        });
        
        // Initialize contract connection
        async function initContract() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    console.log('No wallet detected yet');
                    return;
                }
                
                provider = new ethers.BrowserProvider(window.ethereum);
                
                // Check network
                const network = await provider.getNetwork();
                if (network.chainId !== BigInt(8453)) { // Base mainnet
                    console.warn('Not on Base network');
                    return;
                }
                
                // Initialize read-only contract
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                console.log('✅ Contract initialized');
                
            } catch (error) {
                console.error('Contract init error:', error);
            }
        }
        
        // Sync game state from blockchain
        async function startContractSync() {
            if (!contract) return;
            
            // Initial load
            await loadGameStateFromContract();
            
            // Poll contract every 2 seconds for updates
            setInterval(async () => {
                await loadGameStateFromContract();
            }, 2000);
            
            // Listen for events
            contract.on('PlayerEntered', async (roundId, player, entryNumber, referrer) => {
                console.log('Player entered:', player);
                await loadGameStateFromContract();
                addChatMessage('SYSTEM', `Player #${entryNumber} entered!`);
                playSound('enter');
            });
            
            contract.on('WinnerDrawn', async (roundId, winner, payout, randomSeed) => {
                console.log('Winner:', winner);
                const payoutETH = ethers.formatEther(payout);
                await loadGameStateFromContract();
                addChatMessage('SYSTEM', `🎉 Winner: ${shortenAddress(winner)} won ${payoutETH} ETH!`);
            });
        }
        
        // Load user personal stats
        async function loadUserStats() {
            if (!contract || !userAddress) return;
            
            try {
                const stats = await contract.getPlayerStats(userAddress);
                const [roundsPlayed, roundsWon, winRate] = stats;
                
                document.getElementById('rounds-played').textContent = roundsPlayed.toString();
                document.getElementById('rounds-won').textContent = roundsWon.toString();
                
            } catch (error) {
                console.error('Failed to load user stats:', error);
            }
        }
        
        // Load game state from smart contract
        async function loadGameStateFromContract() {
            if (!contract) return;
            
            try {
                const round = await contract.getCurrentRound();
                const [id, playerCount, pot, timeLeft, isActive, state] = round;
                
                // Update UI with blockchain data
                document.getElementById('round-number').textContent = id.toString();
                document.getElementById('player-count').textContent = `${playerCount}/20`;
                
                const potETH = ethers.formatEther(pot);
                document.getElementById('pot-amount').textContent = parseFloat(potETH).toFixed(4);
                document.getElementById('pot-usd').textContent = '$' + (parseFloat(potETH) * ethPrice).toFixed(2);
                
                // Update timer from contract
                const timeLeftNum = Number(timeLeft);
                roundTimer = timeLeftNum;
                
                if (isActive && timeLeftNum > 0) {
                    updateTimerDisplay();
                    if (!timerInterval) {
                        startSyncedTimer();
                    }
                } else if (playerCount < 2) {
                    document.getElementById('timer').textContent = 'WAITING';
                    if (timerInterval) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                    }
                }
                
                // Load players and their bet amounts
                const players = await contract.getRoundPlayers(id);
                const bets = await contract.getRoundBets(id);
                
                const totalWagered = bets.reduce((sum, bet) => sum + bet, 0n);
                
                currentPlayers = players.map((addr, index) => {
                    const betAmount = bets[index];
                    const betETH = parseFloat(ethers.formatEther(betAmount));
                    const chance = totalWagered > 0n 
                        ? ((Number(betAmount) / Number(totalWagered)) * 100).toFixed(2)
                        : (100 / players.length).toFixed(2);
                    
                    return {
                        address: addr,
                        bet: betETH,
                        betWei: betAmount,
                        chance: chance
                    };
                });
                
                updatePlayersList();
                drawWheel();
                
            } catch (error) {
                console.error('Failed to load game state:', error);
            }
        }
        
        // Synced timer that matches blockchain state
        function startSyncedTimer() {
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(async () => {
                if (!contract) return;
                
                try {
                    const round = await contract.getCurrentRound();
                    const [, , , timeLeft, isActive] = round;
                    const timeLeftNum = Number(timeLeft);
                    
                    roundTimer = timeLeftNum;
                    updateTimerDisplay();
                    
                    if (timeLeftNum <= 0) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                        document.getElementById('timer').textContent = 'DRAWING...';
                    }
                } catch (error) {
                    console.error('Timer sync error:', error);
                }
            }, 1000);
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(roundTimer / 60);
            const seconds = roundTimer % 60;
            const timerEl = document.getElementById('timer');
            timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            if (roundTimer <= 10 && roundTimer > 0) {
                timerEl.classList.add('warning');
                if (roundTimer <= 5) {
                    playSound('tick');
                }
            } else {
                timerEl.classList.remove('warning');
            }
        }
        
        // Wheel
        let canvas, ctx;
        function initWheel() {
            canvas = document.getElementById('jackpot-wheel');
            ctx = canvas.getContext('2d');
            const size = Math.min(400, window.innerWidth - 100);
            canvas.width = size;
            canvas.height = size;
            drawWheel();
        }
        
        function drawWheel() {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = (canvas.width / 2) * 0.85;
            
            ctx.save();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Apply rotation if spinning
            if (isSpinning) {
                ctx.translate(centerX, centerY);
                ctx.rotate(wheelRotation);
                ctx.translate(-centerX, -centerY);
            }
            
            if (currentPlayers.length === 0) {
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
                ctx.fillStyle = '#1a1a3a';
                ctx.fill();
                ctx.strokeStyle = '#ffd700';
                ctx.lineWidth = 3;
                ctx.stroke();
                ctx.restore();
                return;
            }
            
            const colors = ['#0052ff', '#00ff00', '#ff00ff', '#ffff00', '#00ffff', '#ff0052'];
            const totalBets = currentPlayers.reduce((sum, p) => sum + p.bet, 0);
            let currentAngle = -Math.PI / 2;
            
            currentPlayers.forEach((player, i) => {
                const sliceAngle = (player.bet / totalBets) * 2 * Math.PI;
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                
                const gradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, radius);
                gradient.addColorStop(0, colors[i % colors.length]);
                gradient.addColorStop(1, '#1a1a3a');
                ctx.fillStyle = gradient;
                ctx.fill();
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Label
                const midAngle = currentAngle + sliceAngle / 2;
                const textX = centerX + Math.cos(midAngle) * (radius * 0.6);
                const textY = centerY + Math.sin(midAngle) * (radius * 0.6);
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 12px Courier Prime';
                ctx.textAlign = 'center';
                ctx.shadowColor = '#000';
                ctx.shadowBlur = 4;
                ctx.fillText(`${player.chance}%`, textX, textY);
                ctx.shadowBlur = 0;
                
                currentAngle += sliceAngle;
            });
            
            ctx.restore();
        }
        
        // Betting
        function adjustBet(amount) {
            const input = document.getElementById('custom-bet-input');
            currentBetAmount = parseFloat(input.value) || 0;
            currentBetAmount += amount;
            if (currentBetAmount < 0.0001) currentBetAmount = 0.0001;
            input.value = currentBetAmount.toFixed(4);
            updateBetDisplay();
        }
        
        function resetBet() {
            currentBetAmount = 0.001;
            document.getElementById('custom-bet-input').value = '0.001';
            updateBetDisplay();
        }
        
        function updateBetDisplay() {
            const input = document.getElementById('custom-bet-input');
            currentBetAmount = parseFloat(input.value) || 0.001;
            document.getElementById('bet-display').textContent = currentBetAmount.toFixed(4) + ' ETH';
            document.getElementById('bet-usd').textContent = '~$' + (currentBetAmount * ethPrice).toFixed(2);
        }
        
        // Enter round - BLOCKCHAIN TRANSACTION
        async function enterRound() {
            if (!contractDeployed) {
                showToast('⚠️ Contract not deployed yet!', 'error');
                return;
            }
            
            if (!userAddress) {
                showToast('Connect wallet first', 'error');
                openWalletModal();
                return;
            }
            
            // Double check network before transaction
            if (!isOnBaseNetwork) {
                showToast('⚠️ Switch to Base network!', 'error');
                return;
            }
            
            try {
                const network = await provider.getNetwork();
                if (Number(network.chainId) !== BASE_CHAIN_ID_DECIMAL) {
                    showToast('⚠️ Wrong network! Switch to Base (8453)', 'error');
                    isOnBaseNetwork = false;
                    return;
                }
            } catch (error) {
                showToast('⚠️ Network check failed', 'error');
                return;
            }
            
            // Check if already entered
            if (currentPlayers.some(p => p.address.toLowerCase() === userAddress.toLowerCase())) {
                showToast('Already entered this round!', 'error');
                return;
            }
            
            try {
                // Ensure we have signer and provider
                if (!provider) {
                    showToast('⚠️ Reconnect your wallet', 'error');
                    return;
                }
                
                // Verify contract exists at address
                console.log('🔍 Verifying contract at address:', CONTRACT_ADDRESS);
                const code = await provider.getCode(CONTRACT_ADDRESS);
                if (code === '0x' || code === '0x0') {
                    console.error('❌ No contract found at address:', CONTRACT_ADDRESS);
                    showToast('❌ Contract not deployed on this network!', 'error');
                    addChatMessage('SYSTEM', '⚠️ Contract not found on Base network. Please verify deployment.');
                    return;
                }
                console.log('✅ Contract verified at address');
                
                // Get fresh signer for transaction
                signer = await provider.getSigner();
                console.log('✅ Signer ready:', await signer.getAddress());
                
                // Connect contract with signer for transactions
                const contractWithSigner = contract.connect(signer);
                console.log('✅ Contract connected with signer');
                
                // Show loading state
                const enterBtn = document.getElementById('enter-btn');
                const originalText = enterBtn.textContent;
                enterBtn.disabled = true;
                enterBtn.innerHTML = '⏳ SENDING TX... <span class="loading-spinner"></span>';
                enterBtn.classList.add('btn-loading');
                
                // Get referrer from URL if exists
                const urlParams = new URLSearchParams(window.location.search);
                const referrer = urlParams.get('ref') || ethers.ZeroAddress;
                
                // Send transaction
                const betAmount = ethers.parseEther(currentBetAmount.toString());
                console.log('💰 Bet amount:', betAmount.toString(), 'wei');
                console.log('📝 Referrer:', referrer);
                console.log('📤 Sending transaction...');
                
                const tx = await contractWithSigner.enterRound(referrer, { value: betAmount });
                console.log('✅ Transaction sent:', tx.hash);
                
                showToast('Transaction sent! Waiting for confirmation...', 'success');
                enterBtn.textContent = '⏳ CONFIRMING...';
                
                // Wait for confirmation
                const receipt = await tx.wait();
                console.log('✅ Transaction confirmed:', receipt.transactionHash);
                
                showToast('✅ Successfully entered the round!', 'success');
                playSound('enter');
                
                // Reset button
                enterBtn.disabled = false;
                enterBtn.textContent = originalText;
                enterBtn.classList.remove('btn-loading');
                
                // Reload game state
                await loadGameStateFromContract();
                
            } catch (error) {
                console.error('❌ Enter round error:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                console.error('Error data:', error.data);
                
                // Reset button
                const enterBtn = document.getElementById('enter-btn');
                enterBtn.disabled = false;
                enterBtn.textContent = '🎰 ENTER 🎰';
                enterBtn.classList.remove('btn-loading');
                
                // User-friendly error messages
                if (error.code === 'ACTION_REJECTED' || error.code === 4001) {
                    showToast('❌ Transaction cancelled', 'error');
                } else if (error.code === 'CALL_EXCEPTION') {
                    showToast('❌ Contract call failed - verify you are on Base network (Chain ID: 8453)', 'error');
                    addChatMessage('SYSTEM', '⚠️ Make sure you are connected to Base Mainnet (Chain ID: 8453)');
                } else if (error.message && error.message.includes('insufficient funds')) {
                    showToast('❌ Insufficient ETH balance', 'error');
                } else if (error.message && error.message.includes('Already entered')) {
                    showToast('❌ Already entered this round!', 'error');
                } else if (error.message && error.message.includes('user rejected')) {
                    showToast('❌ You rejected the transaction', 'error');
                } else if (error.message && error.message.includes('gas')) {
                    showToast('❌ Gas estimation failed - check network', 'error');
                } else if (error.message && error.message.includes('missing revert data')) {
                    showToast('❌ Contract not found on Base network!', 'error');
                    addChatMessage('SYSTEM', '⚠️ Verify contract is deployed at: ' + CONTRACT_ADDRESS);
                } else {
                    showToast(`❌ Transaction failed: ${error.message || 'Unknown error'}`, 'error');
                }
            }
        }
        
        // Animate wheel when new player joins
        function animateWheelUpdate() {
            let frame = 0;
            const animate = () => {
                frame++;
                if (frame < 10) {
                    drawWheel();
                    requestAnimationFrame(animate);
                }
            };
            animate();
        }
        
        function updatePlayersList() {
            const list = document.getElementById('players-list');
            if (currentPlayers.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #888; font-size: 0.6rem;">Waiting...</div>';
                return;
            }
            list.innerHTML = currentPlayers.map((p, index) => `
                <div class="player-item" style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; flex-direction: column; gap: 3px;">
                        <span class="player-address">${shortenAddress(p.address)}</span>
                        <span style="font-size: 0.5rem; color: #888;">${p.bet.toFixed(4)} ETH wagered</span>
                    </div>
                    <span class="player-chance" style="font-size: 0.7rem; font-weight: bold; color: #00BFFF;">${p.chance}%</span>
                </div>
            `).join('');
        }
        
        // Note: updatePot() is now handled by loadGameStateFromContract()
        // Note: Timer is now synced from blockchain via startSyncedTimer()
        // Note: Winner selection is handled by smart contract
        
        // Spinning wheel animation
        function animateWheelSpin(winnerIndex) {
            isSpinning = true;
            wheelRotation = 0;
            let spins = 0;
            const totalSpins = 5 + Math.random() * 3; // 5-8 full rotations
            const targetAngle = (Math.PI * 2 * totalSpins) + (Math.PI * 2 * winnerIndex / currentPlayers.length);
            
            const duration = 3000; // 3 seconds
            const startTime = Date.now();
            
            function animate() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Easing function (ease-out cubic)
                const eased = 1 - Math.pow(1 - progress, 3);
                wheelRotation = targetAngle * eased;
                
                drawWheel();
                
                // Play tick sound periodically
                if (Math.floor(elapsed / 100) % 3 === 0) {
                    playSound('tick');
                }
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    isSpinning = false;
                    wheelRotation = 0;
                    const winner = currentPlayers[winnerIndex];
                    const payout = currentPlayers.reduce((sum, p) => sum + p.bet, 0) * 0.95;
                    showWinnerAnnouncement(winner, payout);
                }
            }
            
            animate();
        }
        
        function showWinnerAnnouncement(winner, payout) {
            const overlay = document.getElementById('winner-overlay');
            const details = document.getElementById('winner-details');
            
            const isUserWinner = winner.address.toLowerCase() === userAddress?.toLowerCase();
            
            details.innerHTML = `
                <div class="winner-address-big">${isUserWinner ? 'YOU WON!' : shortenAddress(winner.address)}</div>
                <div class="winner-prize">${payout.toFixed(4)} ETH</div>
                <div class="winner-chance">Win Chance: ${winner.chance}%</div>
                <div class="winner-chance">~$${(payout * ethPrice).toFixed(2)} USD</div>
                <button class="winner-close-btn" onclick="closeWinnerAnnouncement()">CONTINUE</button>
            `;
            
            overlay.classList.add('show');
            createConfetti();
            playSound('win');
            
            if (isUserWinner) {
                showToast('🎉 YOU WON THE JACKPOT! 🎉', 'success');
            }
            
            addChatMessage('SYSTEM', `🎉 ${shortenAddress(winner.address)} won ${payout.toFixed(4)} ETH with ${winner.chance}% chance!`);
        }
        
        function closeWinnerAnnouncement() {
            document.getElementById('winner-overlay').classList.remove('show');
            // Game state will auto-reload from contract (new round auto-created)
            if (contractDeployed) {
                loadGameStateFromContract();
            }
        }
        
        // Modals
        function openWalletModal() {
            document.getElementById('wallet-modal').classList.add('show');
        }
        
        function openHelpModal() {
            document.getElementById('help-modal').classList.add('show');
        }
        
        function closeHelpModal() {
            document.getElementById('help-modal').classList.remove('show');
        }
        
        async function connectMetaMask() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    showToast('Install MetaMask!', 'error');
                    return;
                }
                
                // Check and switch to Base network FIRST
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: BASE_CHAIN_ID }],
                    });
                } catch (switchError) {
                    // If network doesn't exist, add it
                    if (switchError.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: BASE_CHAIN_ID,
                                chainName: 'Base Mainnet',
                                nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                                rpcUrls: ['https://mainnet.base.org'],
                                blockExplorerUrls: ['https://basescan.org']
                            }],
                        });
                    } else {
                        throw new Error('Please switch to Base network in MetaMask');
                    }
                }
                
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddress = accounts[0];
                
                // Initialize provider and signer
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                
                // Verify we're on Base network
                const network = await provider.getNetwork();
                if (Number(network.chainId) !== BASE_CHAIN_ID_DECIMAL) {
                    showToast('⚠️ MUST be on Base network!', 'error');
                    disconnectWallet();
                    return;
                }
                
                isOnBaseNetwork = true;
                
                // Initialize contract if deployed
                if (contractDeployed && CONTRACT_ADDRESS !== '0x0000000000000000000000000000000000000000') {
                    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                    
                    // Verify contract exists at address
                    const code = await provider.getCode(CONTRACT_ADDRESS);
                    if (code === '0x' || code === '0x0') {
                        console.error('❌ No contract found at address:', CONTRACT_ADDRESS);
                        showToast('⚠️ Contract not deployed on Base network!', 'error');
                        addChatMessage('SYSTEM', '⚠️ Contract verification failed. Please contact support.');
                        contractDeployed = false;
                    } else {
                        console.log('✅ Contract verified at address:', CONTRACT_ADDRESS);
                        // Enable enter button only if contract is verified
                        document.getElementById('enter-btn').disabled = false;
                        document.getElementById('enter-btn').textContent = '🎰 ENTER 🎰';
                    }
                }
                
                document.getElementById('wallet-btn').style.display = 'none';
                document.getElementById('wallet-connected').style.display = 'flex';
                document.getElementById('wallet-address').textContent = shortenAddress(userAddress);
                
                // Load user stats
                await loadUserStats();
                await loadGlobalStatsFromContract();
                
                // Track online
                trackOnlineUser(userAddress);
                
                document.getElementById('wallet-modal').classList.remove('show');
                showToast('Connected!', 'success');
                
            } catch (error) {
                console.error(error);
                showToast('Connection failed', 'error');
            }
        }
        
        async function connectCoinbase() {
            try {
                if (typeof window.ethereum !== 'undefined' && window.ethereum.isCoinbaseWallet) {
                    // Check and switch to Base network FIRST
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: BASE_CHAIN_ID }],
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: BASE_CHAIN_ID,
                                    chainName: 'Base Mainnet',
                                    nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                                    rpcUrls: ['https://mainnet.base.org'],
                                    blockExplorerUrls: ['https://basescan.org']
                                }],
                            });
                        } else {
                            throw new Error('Please switch to Base network in Coinbase Wallet');
                        }
                    }
                    
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    userAddress = accounts[0];
                    
                    // Initialize provider and signer
                    provider = new ethers.BrowserProvider(window.ethereum);
                    signer = await provider.getSigner();
                    
                    // Verify we're on Base network
                    const network = await provider.getNetwork();
                    if (Number(network.chainId) !== BASE_CHAIN_ID_DECIMAL) {
                        showToast('⚠️ MUST be on Base network!', 'error');
                        disconnectWallet();
                        return;
                    }
                    
                    isOnBaseNetwork = true;
                    
                    // Initialize contract if deployed
                    if (contractDeployed && CONTRACT_ADDRESS !== '0x0000000000000000000000000000000000000000') {
                        contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                        
                        // Verify contract exists at address
                        const code = await provider.getCode(CONTRACT_ADDRESS);
                        if (code === '0x' || code === '0x0') {
                            console.error('❌ No contract found at address:', CONTRACT_ADDRESS);
                            showToast('⚠️ Contract not deployed on Base network!', 'error');
                            addChatMessage('SYSTEM', '⚠️ Contract verification failed. Please contact support.');
                            contractDeployed = false;
                        } else {
                            console.log('✅ Contract verified at address:', CONTRACT_ADDRESS);
                            document.getElementById('enter-btn').disabled = false;
                            document.getElementById('enter-btn').textContent = '🎰 ENTER 🎰';
                        }
                    }
                    
                    document.getElementById('wallet-btn').style.display = 'none';
                    document.getElementById('wallet-connected').style.display = 'flex';
                    document.getElementById('wallet-address').textContent = shortenAddress(userAddress);
                    
                    // Load user stats
                    await loadUserStats();
                    await loadGlobalStatsFromContract();
                    
                    // Track online
                    trackOnlineUser(userAddress);
                    
                    document.getElementById('wallet-modal').classList.remove('show');
                    showToast('Connected!', 'success');
                } else {
                    showToast('Install Coinbase Wallet!', 'error');
                }
            } catch (error) {
                console.error(error);
                showToast('Connection failed', 'error');
            }
        }
        
        async function connectPhantom() {
            try {
                if (typeof window.phantom !== 'undefined' && window.phantom.ethereum) {
                    // Try to switch to Base network (non-blocking)
                    try {
                        await window.phantom.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: BASE_CHAIN_ID }],
                        });
                        console.log('✅ Phantom switched to Base network');
                    } catch (switchError) {
                        // If network doesn't exist, try to add it
                        if (switchError.code === 4902) {
                            try {
                                await window.phantom.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: BASE_CHAIN_ID,
                                        chainName: 'Base Mainnet',
                                        nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                                        rpcUrls: ['https://mainnet.base.org'],
                                        blockExplorerUrls: ['https://basescan.org']
                                    }],
                                });
                            } catch (addError) {
                                console.warn('⚠️ Failed to add Base network, continuing anyway');
                            }
                        } else {
                            console.warn('⚠️ Network switch failed or rejected, continuing with current network');
                        }
                    }
                    
                    const accounts = await window.phantom.ethereum.request({ method: 'eth_requestAccounts' });
                    userAddress = accounts[0];
                    
                    // Initialize provider and signer
                    provider = new ethers.BrowserProvider(window.phantom.ethereum);
                    signer = await provider.getSigner();
                    
                    // Verify we're on Base network
                    const network = await provider.getNetwork();
                    if (Number(network.chainId) !== BASE_CHAIN_ID_DECIMAL) {
                        showToast('⚠️ MUST be on Base network!', 'error');
                        disconnectWallet();
                        return;
                    }
                    
                    isOnBaseNetwork = true;
                    
                    // Initialize contract if deployed
                    if (contractDeployed && CONTRACT_ADDRESS !== '0x0000000000000000000000000000000000000000') {
                        contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                        
                        // Verify contract exists at address
                        const code = await provider.getCode(CONTRACT_ADDRESS);
                        if (code === '0x' || code === '0x0') {
                            console.error('❌ No contract found at address:', CONTRACT_ADDRESS);
                            showToast('⚠️ Contract not deployed on Base network!', 'error');
                            addChatMessage('SYSTEM', '⚠️ Contract verification failed. Please contact support.');
                            contractDeployed = false;
                        } else {
                            console.log('✅ Contract verified at address:', CONTRACT_ADDRESS);
                            document.getElementById('enter-btn').disabled = false;
                            document.getElementById('enter-btn').textContent = '🎰 ENTER 🎰';
                        }
                    }
                    
                    document.getElementById('wallet-btn').style.display = 'none';
                    document.getElementById('wallet-connected').style.display = 'flex';
                    document.getElementById('wallet-address').textContent = shortenAddress(userAddress);
                    
                    // Load user stats
                    await loadUserStats();
                    await loadGlobalStatsFromContract();
                    
                    // Track online
                    trackOnlineUser(userAddress);
                    
                    document.getElementById('wallet-modal').classList.remove('show');
                    showToast('Connected!', 'success');
                } else {
                    showToast('Install Phantom!', 'error');
                }
            } catch (error) {
                console.error(error);
                showToast('Connection failed', 'error');
            }
        }
        
        function disconnectWallet() {
            userAddress = null;
            isOnBaseNetwork = false;
            provider = null;
            signer = null;
            contract = null;
            document.getElementById('wallet-btn').style.display = 'block';
            document.getElementById('wallet-connected').style.display = 'none';
            document.getElementById('enter-btn').disabled = true;
            showToast('Disconnected', 'success');
        }
        
        // Chat - Supabase Integration with online users
        let chatPollInterval;
        let onlineUsers = new Set();
        
        async function loadChatMessages() {
            try {
                console.log('📥 Loading chat messages...');
                // Fetch messages from Supabase
                const response = await fetch('/api/chat/messages?channel=luckyblock&limit=50');
                console.log('📥 Chat response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('❌ Chat load error:', response.status, errorText);
                    throw new Error(`Failed to load chat: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('✅ Chat data loaded:', data.messages?.length || 0, 'messages');
                
                const messagesDiv = document.getElementById('chat-messages');
                messagesDiv.innerHTML = '<div class="chat-system">🟢 Connected to #luckyblock</div>';
                
                if (data.messages && data.messages.length > 0) {
                    data.messages.forEach(msg => {
                        const username = msg.user?.username || shortenAddress(msg.user?.walletAddress);
                        addChatMessage(username, msg.content, false);
                        onlineUsers.add(username);
                    });
                    console.log('✅ Loaded', data.messages.length, 'messages');
                }
                
                updateOnlineCount();
                
                // Start polling for new messages every 3 seconds
                if (chatPollInterval) clearInterval(chatPollInterval);
                chatPollInterval = setInterval(loadNewMessages, 3000);
                
            } catch (error) {
                console.error('❌ Chat load error:', error);
                addChatMessage('SYSTEM', '🔴 Chat offline - Enable chat in settings or check network');
            }
        }
        
        function updateOnlineCount() {
            // Update chat header
            const header = document.querySelector('.chat-header');
            const count = onlineUsers.size + currentPlayers.length;
            header.textContent = `💬 CHAT (${count} online) 💬`;
            
            // Update online users list
            const onlineUsersDiv = document.getElementById('online-users');
            if (onlineUsers.size === 0 && currentPlayers.length === 0) {
                onlineUsersDiv.innerHTML = '<div style="text-align: center; padding: 10px;">No users yet</div>';
                return;
            }
            
            const allUsers = new Set([...Array.from(onlineUsers), ...currentPlayers.map(p => shortenAddress(p.address))]);
            onlineUsersDiv.innerHTML = Array.from(allUsers).map(user => `
                <div style="padding: 5px; border-bottom: 1px solid rgba(0, 82, 255, 0.2);">
                    <span style="color: #00FF88;">●</span> ${user}
                </div>
            `).join('');
        }
        
        let lastMessageId = null;
        
        async function loadNewMessages() {
            try {
                const url = lastMessageId 
                    ? `/api/chat/messages?channel=luckyblock&after=${lastMessageId}`
                    : '/api/chat/messages?channel=luckyblock&limit=10';
                    
                const response = await fetch(url);
                if (!response.ok) return;
                
                const data = await response.json();
                if (data.messages && data.messages.length > 0) {
                    data.messages.forEach(msg => {
                        const username = msg.user?.username || shortenAddress(msg.user?.walletAddress);
                        addChatMessage(username, msg.content, false);
                        lastMessageId = msg.id;
                    });
                }
            } catch (error) {
                console.error('Chat poll error:', error);
            }
        }
        
        function addChatMessage(username, text, scroll = true) {
            const messagesDiv = document.getElementById('chat-messages');
            const msg = document.createElement('div');
            msg.className = username === 'SYSTEM' ? 'chat-system' : 'chat-message';
            
            if (username === 'SYSTEM') {
                msg.textContent = text;
            } else {
                msg.innerHTML = `<span class="chat-username">${username}:</span><span class="chat-text"> ${text}</span>`;
            }
            
            messagesDiv.appendChild(msg);
            
            // Keep only last 100 messages
            while (messagesDiv.children.length > 100) {
                messagesDiv.removeChild(messagesDiv.firstChild);
            }
            
            if (scroll) {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }
        
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            
            if (!text) return;
            
            if (!userAddress) {
                showToast('Connect wallet to chat', 'error');
                return;
            }
            
            // Send to Supabase
            try {
                const username = localStorage.getItem('basement_username') || shortenAddress(userAddress);
                console.log('📤 Sending message:', text.substring(0, 50));
                
                const response = await fetch('/api/chat/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        channelSlug: 'luckyblock',
                        content: text,
                        walletAddress: userAddress,
                        username: username,
                        isAnonymous: false
                    })
                });
                
                console.log('📤 Message response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('✅ Message sent:', data);
                    input.value = '';
                    // Message will appear via polling
                } else {
                    const errorText = await response.text();
                    console.error('❌ Message failed:', response.status, errorText);
                    // Fallback to local display
                    addChatMessage(username, text);
                    input.value = '';
                    showToast('⚠️ Chat server unavailable - message sent locally', 'error');
                }
            } catch (error) {
                console.error('❌ Send message error:', error);
                // Fallback to local
                addChatMessage(shortenAddress(userAddress), text);
                input.value = '';
                showToast('⚠️ Message sent locally only', 'error');
            }
        }
        
        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        
        // ETH Price
        async function fetchETHPrice() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd');
                const data = await response.json();
                ethPrice = data.ethereum.usd || 2000;
                console.log('✅ ETH price:', ethPrice);
                updateBetDisplay();
            } catch (error) {
                console.error('ETH price fetch failed:', error);
                ethPrice = 2000;
            }
        }
        
        setInterval(fetchETHPrice, 30000);
        
        // Utils
        function shortenAddress(addr) {
            if (!addr) return '';
            return addr.substring(0, 6) + '...' + addr.substring(38);
        }
        
        function showToast(msg, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        function createConfetti() {
            const colors = ['#ffd700', '#00ffff', '#ff00ff', '#00ff00'];
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), 3000);
            }
        }
        
        window.addEventListener('resize', () => {
            if (canvas) {
                const size = Math.min(400, window.innerWidth - 100);
                canvas.width = size;
                canvas.height = size;
                drawWheel();
            }
        });
    </script>
</body>
</html>

